"""
背景生成模块
生成患者24小时生活状态
"""
from typing import Dict, Any
from .api_client import QwenAPIClient


class BackgroundGenerator:
    """背景生成器"""
    
    def __init__(self, api_client: QwenAPIClient):
        """
        初始化背景生成器
        
        Args:
            api_client: API客户端实例
        """
        self.api_client = api_client
    
    def generate_background(self, persona: Dict[str, Any], dialogue_topic: str) -> str:
        """
        生成患者24小时生活状态
        
        Args:
            persona: 患者用户画像
            dialogue_topic: 与照护师的对话主题
            
        Returns:
            24小时生活状态描述
        """
        # 构建提示词
        prompt = self._build_background_prompt(persona, dialogue_topic)
        
        # 调用API生成
        result = self.api_client.call(
            prompt=prompt,
            model="qwen-plus",
            temperature=0.8,
            max_tokens=2000
        )
        
        return result
    
    def _build_background_prompt(self, persona: Dict[str, Any], dialogue_topic: str) -> str:
        """构建背景生成的提示词"""
        
        prompt = """### 任务描述
你是一位血糖异常患者，需要基于你的用户画像、以及你与照护师的对话主题，描述你24小时内详尽的生活状态，特别是与饮食、血糖、运动、用药、体重等方面相关的经历。这些分享将帮助照护师更了解你的实际情况，从而为你提供更合适的个性化照护计划。

### 输入信息
你将获得以下信息：
1. **你的用户画像**：包含你的基本信息、核心性格特征、沟通与交互特点、行为与认知模式、医疗背景与专业认知等维度
2. **你与照护师的对话主题**：最近一次对话中讨论的主要内容

### 指导原则
在生成你的24小时生活状态描述时，请遵循以下原则：
1. **真实性**：描述应真实反映血糖异常患者的日常生活，避免理想化或过度负面
2. **具体性**：提供具体细节而非笼统描述，如具体食物、具体运动形式、血糖数值等
3. **连续性**：各时间段之间保持逻辑连接，展示血糖管理的整体情况
4. **医学合理性**：描述应符合糖尿病管理的医学常识
5. **逻辑性**：你的24小时生活状态不应该与你的用户画像或是你与照护师的对话主题有逻辑上违背之处。

### 专业考量
在生成内容时，请考虑以下专业因素：

1. **血糖波动规律**：
   - 考虑餐后血糖峰值出现时间（通常在餐后1-2小时）
   - 考虑空腹血糖水平（受黎明现象影响）
   - 考虑运动对血糖的即时和延迟影响
   - 考虑药物作用时间和峰值时间

2. **饮食-血糖关系**：
   - 碳水化合物摄入量与血糖升高的关系
   - 蛋白质和脂肪对血糖的缓慢影响
   - 进食顺序对血糖的影响（如先吃蔬菜后吃主食）
   - 食物血糖指数（GI）和血糖负荷（GL）的应用

3. **运动-血糖关系**：
   - 有氧运动与无氧运动对血糖的不同影响
   - 运动强度与持续时间对血糖的影响
   - 运动时间（餐前、餐后）对血糖的影响
   - 运动前后血糖监测的重要性

4. **用药-血糖关系**：
   - 不同类型降糖药的作用时间和峰值时间
   - 胰岛素种类与作用时间曲线（速效、短效、中效、长效）
   - 用药时间与进餐时间的匹配关系
   - 药物不良反应对生活状态的影响

### 输出要求
请根据输入信息，生成以下内容：

# 24小时生活状态
**内容维度**: 以下各个与血糖管理强相关的内容，你需要详细描述
- **饮食情况**: 包括你吃了什么、什么时候吃的、吃了多少、感觉如何等
- **血糖监测**: 包括你什么时候测血糖、结果如何、你的感受等
- **运动活动**: 包括你做了什么运动、做了多久、感觉如何等
- **用药情况**: 包括你吃了什么药、什么时候吃的、有没有忘记吃药等
- **体重相关**: 包括你什么时候称体重、结果如何、你的感受等
- **其他**: 包括你最近是否发生了某些特殊事件（特殊事件要和血糖管理有一点点相关性）、你的某种长期生活习惯等，包括一些其他方面的内容。注意，该维度的内容不要叙述太多！！！

## 输出格式
请按照以下格式输出：

### 24小时生活状态
- **饮食情况**: [详细描述吃了什么]
- **血糖监测**: [详细描述测血糖的情况]
- **运动活动**: [详细描述做了什么运动]
- **用药情况**: [详细描述用药的情况]
- **体重相关**: [详细描述体重相关的情况]
- **其他**: [描述其他方面]

## 用户画像
"""
        
        # 添加用户画像
        import json
        prompt += "\n" + json.dumps(persona, ensure_ascii=False, indent=2)
        
        prompt += f"""

### 与照护师对话主题
{dialogue_topic}
"""
        
        return prompt


"""
故事生成模块
根据主题和患者特点生成故事背景
"""
from typing import Dict, Any
from .api_client import QwenAPIClient


class StoryGenerator:
    """故事生成器"""
    
    def __init__(self, api_client: QwenAPIClient):
        """
        初始化故事生成器
        
        Args:
            api_client: API客户端实例
        """
        self.api_client = api_client
    
    def generate_story(self, persona: Dict[str, Any], topic: str) -> str:
        """
        生成故事背景
        
        Args:
            persona: 患者用户画像
            topic: 对话主题
            
        Returns:
            故事背景描述（不超过400字）
        """
        # 构建提示词
        prompt = self._build_story_prompt(persona, topic)
        
        # 调用API生成
        result = self.api_client.call(
            prompt=prompt,
            model="qwen-plus",
            temperature=0.8,      
            max_tokens=800
        )
        
        return result
    
    def _build_story_prompt(self, persona: Dict[str, Any], topic: str) -> str:
        """构建故事生成的提示词（优化版，已修复缩进）"""
        
        prompt = """你是一位血糖异常（糖尿病）患者，将要和照护师开始一次对话。请用第一人称（“我”），自然口语化地叙述一段故事性背景描述，作为这次对话的开场铺垫。这段话就是患者会发出的第一条消息。

### 核心要求
1. **叙述视角**：全程用第一人称，像真实患者在向照护师倾诉近况一样，语言自然、内敛、带生活气息，避免夸张戏剧化。
2. **内容必须自然融合以下三要素**（不要分点，直接融入一段连贯的话）：
   - **背景**：主题事件是怎么发生的、最近的具体情况、触发异常的细节。
   - **目的**：为什么想和照护师聊这个（担心潜在风险、想确认安全、希望得到原因分析和明确建议、缓解焦虑等）。
   - **人物特点**：充分体现患者的核心性格（焦虑确认的守线者）：对异常高度敏感、倾向灾难化联想、喜欢确认边界和安全、反复测量求证、需要确定感、配合度高但遇到不确定会停下来确认等。
3. **长度控制**：250-350字左右，绝对不超过400字。
4. **风格要求**：
   - 真实可信，像中年慢性病患者会说的话，略带焦虑但整体克制。
   - 可以包含具体细节（如时间、吃的食物、血糖数值、身体感受、补打胰岛素等）。
   - 医学描述符合常识，但不用专业术语。
   - 情绪表达适度（适时表达情绪，但不夸张）。
5. **严禁内容**：
   - 不能出现任何对话形式（如“您好”“医生我想问”）。
   - 不能预设照护师的回应。
   - 不能直接提出具体问题或要求（如“请您分析原因”）。
   - 不能用列表、编号、标题。
6. **输出格式**：直接输出正文一段完整的话，不要加任何标题、引号、说明或前缀。

### 示例（严格参考此风格和长度）
患者用户画像：（与当前患者一致，焦虑确认的守线者，语言表现层中等长度、聚焦单点、边界追问等）
主题：患者上午带娃在游乐园玩，中午在外面的餐厅吃饭。血糖最高值达到了16.4mmol/L，刚刚补打了胰岛素，补打得有点晚了。患者想先像平常一样和照护师分享一下血糖测量数据，再让照护师分析分析今天的血糖值飙升到这么高的原因。

输出示例：
今天上午带孩子去游乐园玩了一上午，走了好多路，中午就在附近一家餐厅随便吃了点米饭、宫保鸡丁和一点青菜。本来以为没什么问题，结果下午两点测血糖的时候一下子跳到16.4，心一下子就提起来了，反复又测了一次还是这么高，真的有点慌。赶紧补打了速效胰岛素，不过比平时晚了点，心里一直不太踏实，总担心这次高得这么厉害会不会有什么问题。平时我都很注意的，这次也不知道到底是哪里出了问题。就是想跟您说说今天的情况，看看是不是有什么需要注意的。

### 患者用户画像
"""
        
        import json
        prompt += json.dumps(persona, ensure_ascii=False, indent=2)
        
        prompt += f"""

### 对话主题
{topic}

现在，请直接输出故事背景描述（第一人称，一段完整自然的话，250-350字左右）：
"""
        
        return prompt

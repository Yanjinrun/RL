"""
患者画像生成模块
根据规则拼接生成的用户画像进行重写和扩写
"""
from typing import Dict, Any
from .api_client import QwenAPIClient


class PersonaGenerator:
    """患者画像生成器"""
    
    def __init__(self, api_client: QwenAPIClient):
        """
        初始化画像生成器
        
        Args:
            api_client: API客户端实例
        """
        self.api_client = api_client
    
    def generate_persona(self, raw_persona: Dict[str, Any]) -> str:
        """
        生成重写和扩写后的患者画像
        
        Args:
            raw_persona: 原始用户画像（JSON格式的字典）
            
        Returns:
            重写和扩写后的患者画像文本
        """
        # 构建提示词
        prompt = self._build_persona_prompt(raw_persona)
        
        # 调用API生成
        result = self.api_client.call(
            prompt=prompt,
            model="qwen-plus",
            temperature=0.7,
            max_tokens=3000
        )
        
        return result
    
    def _build_persona_prompt(self, raw_persona: Dict[str, Any]) -> str:
        """构建患者画像生成的提示词"""
        
        prompt = """### 任务描述
你需要将一个基于规则拼接生成的用户画像进行"重写"和"扩写"，让其更自然流畅，更适合AI模型理解和使用。

### 重写原则

1. **保持核心内容不变**：所有关键信息和特征描述都必须保留
2. **增强可读性**：将信息的规则性描述转换为自然的叙述性文字
3. **逻辑整合**：将分散的维度信息整合成连贯的人物描述
4. **突出重点**：强调最核心的性格特征和行为模式
5. **情境化表达**：用具体的行为表现来描述抽象的特征

### 重写要求
1. **语言自然化**：避免生硬的分类标签，用自然语言描述
2. **信息结构化**：按照逻辑顺序重新组织信息
3. **特征具体化**：将抽象的性格描述转换为具体的行为表现
4. **删除冗余**：去除重复或不必要的描述
5. **增加连接**：在不同维度之间建立自然的逻辑联系

### 扩写原则
根据已选规则和信息，并充分考虑多个维度下的共同驱动效果，扩写出匹配的以下的语言表现和互动特征。

A. 语言表现层：即患者的语言表现，患者在对话里"怎么说，怎么回，怎么确认"的稳定样子。11项需全部选择出最贴合画像的结论。
1. 回复长度（单条回复的字数与信息量）：极短（5个字以内）or 短（5-10个字）or 中（10-20个字）or 长（1-3句）or 很长（3句以上/小段/系列①②③）
2. 回合组织方式（一次发一条长信息，还是拆成多条连续短消息，影响对话节奏）：带条长回（一次说完背景、问题、结论或想说的话）or 多条连线（想说的话分多次发送）
3. 覆盖度或投入程度（对对方多个问题/要点的回应范围与认真程度）：只回一个点 or 逐项逐条回复；
4. 话题拓展（是否主动展开话题或补充情境/数据）：主动拓展话题或补充情境/数据 or 在需要时偶尔主动拓展话题或补充情境/数据 or 从不主动拓展话题或补充情境/数据
5. 追问类型（偏向哪类问题—操作、原理、风险/边界）：操作型（偏好告诉我步骤）or 原理型（偏好问为什么）or 风险/边界（偏好问算不算偏高，是不是危险）
6. 是否共同决策（希望对方直接拍板、给选项，还是共同商议）：偏好系统直接决定 or 有选项供选择 or 共同商议
7. 拒绝与直接性（不同意或者不愿配合时的表达强度）：直接拒绝（不方便）or 有条件拒绝（等X时候我再考虑）
8. 情绪线性的强度（性格底色中情绪表达的强度）：表达强烈 or 适时表达情绪 or 不表达情绪
9. 信任显性程度（表达是否信任的程度）：信任（听你的，按你说的来）or 谨慎（依据是什么？为什么？）or 不信任（不理解或者拒绝）
10. 主动提问能力（是否会针对当前话题主动提出自己的想法或疑问）：没有主动提问能力 or 偶尔主动提问 or 总是主动提问
11. 获取敏感信息（例如用药信息、检查结果、病历或其他个人信息）的难度：简单（向患者索要敏感信息时，患者总是很配合）or 中等（向患者索要敏感信息时，总是需要充分说服才能配合）or 难（向患者索要敏感信息时，无法说服患者配合）

B. 互动干扰项：对话中节奏的阻力或变量，会扰乱正常对话节奏的维度。从下列清单中选择最贴合画像的6-8项。
1. 话题的过渡循环（患者过于执着某一话题，使主线难以推动，回合暴增或话题停留在原地）：
L0（可以顺应系统的主线推动节奏）or L1（有时可以放下执念进入主线节奏）or L2（不彻底解决他当下的问题绝不进入主线节奏）
2. 灾难化（不排除最坏的情况，或者不确认自己安全就无法推进话题）: L0（几乎不灾难化联想）or L1（轻度担忧）or L2（明显灾难化联想）
3. 边界循环（反复追问和确认定义和边界，否则就无法推进话题）: L0（低 边界敏感）or L1（偶尔追问）or L2（高 边界敏感，抛物概率/定义本身，很难推进主线）
4. 过度确认/重复（信息或任务总需要再次确认或重复），使回合暴增，节奏碎片化）: L0（不进行）or L1（偶尔确认）or L2（频繁确认）
5. 多线程并发（一条会话里总是提问多个维度的问题）：L0（单主线，只就一个主题互动） or L1（偶尔插入其他话题） or L2（频繁插入其他主题）
6. 话题聚集程度（话题是否能给终端端主线，易跑题会使会话拖沓）：L0（紧扣主线） or L1（偶尔跑题） or L2（频繁跑题）
7. 情绪缓解程度（负面情绪是否容易疏导，如果话题一直围绕情绪疏导则使主线无法进行或者让会话停止）：L0（情绪低敏感，很快走出情绪并结束情绪话题，进入主线） or L1（情绪中敏感，适当安抚后可以走出情绪并结束情绪话题，进入主线） or L2（情绪高敏感，即使安抚也很难从情绪中走出，并且话题一直停留在情绪安抚上，难以进入主线）
8. 配合程度/参与姿态（对建议/任务或者对话互动的接受程度/配合程度）：L0（高配合，对话或者互动中，很容易察觉有效信息，很容易进行退款） or L1（有限配合，对话或者互动中，可以察觉大部分信息，可以接受大部分退款。并且在适当的说服后可以提高配合程度） or L2（低配和，对话或者互动中，很难察觉有效信息，很难进行退款，尤其涉及敏感信息（例如用药、检查结果、病例等），需要充分的说服后才能配合。） or L3（拒绝配合，对话或者互动中，即使说服也不配合，很难察觉有效信息，很难进行退款。）
9. 证据门槛与确定性需求（接受建议前需要的依据，或确定性证据的程度，影响对话回合与节奏）：L0（低门槛："好的我服做"） or L1（中门槛："为什么"） or L2（高门槛：权威依据）
10. 信任与质疑（对系统专业性、善意的质疑程度）：L0（高信任，有问必答，愿意分享自己的信息，并且充分接受系统善意的干预建议。） or L1（谨慎，敏感信息（例如用药、检查结果、病例等）需要确认必要性，或者被充分说服后才会分享，并在了解系统动机之后可接受干预建议。） or L2（质疑，不愿意与系统分享自己的信息，也不愿接受系统的干预建议。）
11. 冲突强度（是否会容易产生冲突或对立的语言）：L0（兼容："谢谢""明白"） or L1（轻冲突） or L2（明显冲突）

### 扩写要求
根据画像扩写完成A.语言表现层（所有11项）和B.互动干扰项（选择最贴合的6-8项）的内容

### 输出格式
请按照以下结构输出重写后的用户画像：

### 患者基本信息
[整合基本信息，简洁明了]

### 核心性格特征
[重点描述患者的性格底色，用自然语言表达其在医疗情境中的表现]

### 沟通与交互特点
[描述患者的沟通偏好和互动方式，整合信任程度信息]

### 行为与认知模式
[整合动机类型、行为认知、认知程度等信息，描述患者的行为模式]

### 医疗背景与专业认知
[整合疾病状态和医学专业性信息]

### 语言表现层
[整合语言表现层的11个项目]

### 互动干扰项
[整合互动干扰项最贴切图像的6-8项]

### 原始用户画像
"""
        
        # 添加原始画像数据
        import json
        prompt += "\n\n" + json.dumps(raw_persona, ensure_ascii=False, indent=2)
        
        return prompt

